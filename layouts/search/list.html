{{ define "main" }}
<div class="pa3 pa4-ns nested-copy-line-height">
  <section class="cf ph3 ph5-l pv3 pv4-l f4 tc-l center measure-wide lh-copy mid-gray">
    <h1 class="f1 athelas mt3 mb1">Search Results</h1>
    
    <!-- Search Input Form -->
    <div class="search-form mb4">
      <form action="/search/" method="GET" class="flex items-center justify-center">
        <input 
          type="text" 
          name="q" 
          id="search-input"
          placeholder="Search blog posts..."
          value="{{ .Params.query | default "" }}"
          class="input-reset ba b--black-20 pa2 mb2 db w-100 w-auto-ns mr2-ns"
          required
        />
        <button 
          type="submit" 
          class="f6 link dim br2 ph3 pv2 mb2 dib white bg-black"
        >
          Search
        </button>
      </form>
    </div>

    <!-- Search Results -->
    <div id="search-results">
      <div class="search-loading" style="display: none;">
        <p>Searching...</p>
      </div>
      <div class="search-no-results" style="display: none;">
        <p>No results found for "<span id="search-query"></span>"</p>
        <p>Try different keywords or check your spelling.</p>
      </div>
      <div id="search-results-list"></div>
    </div>
  </section>
</div>

<!-- Optimized JavaScript - Reduced footprint -->
<script>
(function() {
  'use strict';
  
  // Cache DOM elements
  const elements = {
    searchQuery: null,
    searchInput: null,
    loading: null,
    noResults: null,
    resultsList: null
  };
  
  // Initialize search functionality
  function initSearch() {
    const urlParams = new URLSearchParams(window.location.search);
    const query = urlParams.get('q');
    
    if (query) {
      elements.searchQuery.textContent = query;
      elements.searchInput.value = query;
      performSearch(query);
    }
  }
  
  // Perform search with optimized logic
  async function performSearch(query) {
    elements.loading.style.display = 'block';
    elements.noResults.style.display = 'none';
    elements.resultsList.innerHTML = '';
    
    try {
      const response = await fetch('/search-index.json');
      if (!response.ok) throw new Error(`HTTP ${response.status}`);
      
      const data = await response.json();
      const results = searchPosts(data, query);
      displayResults(results, query);
    } catch (error) {
      console.error('Search failed:', error);
      elements.noResults.style.display = 'block';
      elements.noResults.innerHTML = '<p>Search temporarily unavailable. Please try again later.</p>';
    } finally {
      elements.loading.style.display = 'none';
    }
  }
  
  // Optimized search algorithm
  function searchPosts(posts, query) {
    const terms = query.toLowerCase().split(' ').filter(t => t.length > 0);
    const termSet = new Set(terms);
    
    return posts
      .map(post => {
        const content = `${post.title} ${post.description} ${(post.tags || []).join(' ')}`.toLowerCase();
        const matches = terms.filter(term => content.includes(term));
        return { ...post, score: matches.length / terms.length, matches: matches.length };
      })
      .filter(post => post.score > 0)
      .sort((a, b) => b.score - a.score);
  }
  
  // Display results efficiently
  function displayResults(results, query) {
    if (results.length === 0) {
      elements.noResults.style.display = 'block';
      return;
    }
    
    const terms = query.toLowerCase().split(' ').filter(t => t.length > 0);
    const resultsHtml = results.map(post => `
      <article class="mb4 bg-white pa3 br2 shadow-1">
        <h2 class="f3 near-black mb2">
          <a href="${post.url}" class="link black dim">
            ${highlightTerms(post.title, terms)}
          </a>
        </h2>
        <div class="f6 mb2">
          <time datetime="${post.date}">${formatDate(post.date)}</time>
          ${post.tags ? `<span class="ml2">Tags: ${post.tags.join(', ')}</span>` : ''}
        </div>
        <p class="f5 lh-copy nested-copy-line-height">
          ${highlightTerms(post.description, terms)}
        </p>
        <a href="${post.url}" class="ba b--moon-gray bg-light-gray br2 color-inherit dib f7 hover-bg-moon-gray link mt2 ph2 pv1">
          Continue reading: ${post.title}
        </a>
      </article>
    `).join('');
    
    elements.resultsList.innerHTML = resultsHtml;
  }
  
  // Efficient highlighting
  function highlightTerms(text, terms) {
    let highlighted = text;
    terms.forEach(term => {
      const regex = new RegExp(`(${term})`, 'gi');
      highlighted = highlighted.replace(regex, '<mark>$1</mark>');
    });
    return highlighted;
  }
  
  // Simple date formatting
  function formatDate(dateString) {
    const date = new Date(dateString);
    return date.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
  }
  
  // Initialize when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initSearch);
  } else {
    initSearch();
  }
})();
</script>

<style>
.search-form {
  margin-bottom: 2rem;
}

.search-form input {
  min-width: 300px;
}

.search-loading {
  text-align: center;
  padding: 2rem;
  color: #6b7280;
}

.search-no-results {
  text-align: center;
  padding: 2rem;
  color: #6b7280;
}

#search-results-list article {
  transition: transform 0.2s;
}

#search-results-list article:hover {
  transform: translateY(-2px);
}

mark {
  background-color: #fef3c7;
  padding: 0.1rem 0.2rem;
  border-radius: 0.25rem;
}
</style>
{{ end }}
